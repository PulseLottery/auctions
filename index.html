<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auction Contract</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.6.1/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // MetaMask setup
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contractAddress = '0x218922B16bDCD7C76442bF9Cc3CF9C83E44CFa8a'; // Replace with your actual contract address
        const auctionContractABI = [
	{
		"inputs": [],
		"name": "depositFunds",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "endAuction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "joinAuction",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "startNewAuction",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "winner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "winningPrice",
				"type": "uint256"
			}
		],
		"name": "Win",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "withdrawFunds",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "auctionActive",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "auctionDuration",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "endTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getTimeRemaining",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "lastBidder",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address payable",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "packageSize",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "price",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "remainingPackets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "startTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "timeRemaining",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
        const auctionContract = new ethers.Contract(contractAddress, auctionContractABI, signer);

        $(document).ready(async function () {
            // Sample button IDs
            const placeBidButton = document.getElementById("placeBidButton");
            const endAuctionButton = document.getElementById("endAuctionButton");
            const startNewAuction = document.getElementById("startNewAuction");

            // Function to display errors
            function displayError(message) {
                const errorContainer = document.getElementById("errorContainer");
                errorContainer.textContent = message;
                errorContainer.style.display = "block";
            }

            // Function to hide errors
            function hideError() {
                const errorContainer = document.getElementById("errorContainer");
                errorContainer.style.display = "none";
            }

            // Event handler for "Place Bid" button
            placeBidButton.addEventListener("click", async function () {
                hideError(); // Hide previous error

                const bidAmount = ethers.utils.parseEther("1000"); // Set bid amount to 1000

                try {
                    const transaction = await auctionContract.joinAuction({ value: bidAmount });
                    await transaction.wait();
                    console.log("Successfully joined the auction!");
                } catch (error) {
                    const errorMessage = "An error occurred while joining the auction: " + error.message;
                    console.log(errorMessage);
                    displayError(errorMessage);
                }
            });

            // Event handler for "End Auction" button
            endAuctionButton.addEventListener("click", async function () {
                hideError(); // Hide previous error

                try {
                    const transaction = await auctionContract.endAuction();
                    await transaction.wait();
                    console.log("Auction ended!");
                } catch (error) {
                    const errorMessage = "An error occurred while ending the auction: " + error.message;
                    console.log(errorMessage);
                    displayError(errorMessage);
                }
            });

            // Event handler for "Start New Auction" button
            startNewAuction.addEventListener("click", async function () {
                hideError(); // Hide previous error

                try {
                    const transaction = await auctionContract.startNewAuction();
                    await transaction.wait();
                    console.log("New auction started!");
                } catch (error) {
                    const errorMessage = "An error occurred while starting a new auction: " + error.message;
                    console.log(errorMessage);
                    displayError(errorMessage);
                }
            });

            // Function to update contract information
            async function updateContractInfo() {
                const startTime = await auctionContract.startTime();
                const lastBidder = await auctionContract.lastBidder();
                const isActive = await auctionContract.auctionActive();
                const remainingPackets = await auctionContract.remainingPackets();
                const timeRemaining = await auctionContract.getTimeRemaining();
                const currentPrice = await auctionContract.price();

                // Update HTML elements with the information
                const startDate = new Date(startTime * 1000);
                const startTimeString = startDate.toLocaleString();
                $("#startTime").text("Start Time: " + startTimeString);
                $("#lastBidder").text("Last Bidder: " + lastBidder);
                $("#isActive").text("Auction Active: " + isActive);
                $("#remainingPackets").text("Reward: 100 000 PLS").css("font-weight", "bold");
                $("#timeRemaining").text("Time Remaining: " + timeRemaining + " sec");
                $("#currentPrice").text("Bids: " + currentPrice);
				
				// Get the number of connected accounts from MetaMask
                const accounts = await ethereum.request({ method: "eth_accounts" });
                const connectedAccountsCount = accounts.length;
                $("#connectedAccounts").text("Connected Accounts: " + connectedAccountsCount);
            }

            // Call the function to update contract information on page load
            await updateContractInfo();

            // Periodically update contract information every 1 second
            setInterval(async function () {
                await updateContractInfo();
            }, 1000);
        });
    </script>
    <style>
        #errorContainer {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
		#connectedAccounts {
            position: center;
            top: 10px;
            right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Auction Contract</h1>
    <p id="startTime">Start Time: </p>
    <p id="lastBidder">Last Bidder: </p>
    <p id="isActive">Auction Active: </p>
    <p id="remainingPackets">Reward: </p>
    <p id="timeRemaining">Time Remaining: </p>
    <p id="currentPrice">Bids: </p>

    <button id="placeBidButton">BID</button>
    <button id="endAuctionButton">END AUCTION</button>
    <button id="startNewAuction">START NEW AUCTION</button>

    <div id="errorContainer"></div>
	<p id="connectedAccounts"></p>
	
	<!-- English Translation -->
	<h2>Participation Rules:</h2>
	<ul>
		<li>The auction starts upon deploying the contract and lasts for a specified duration, by default 3600 seconds (1 hour).</li>
		<li>To join the auction, participants need to send a transaction with a deposit value equal to or greater than <b>1000 PLS</b> .</li>
		<li>Upon joining the auction, if the remaining time is less than 5 minutes, 1 minute is added to the auction end time.</li>
		<li>If the auction end time has passed, the auction is concluded.</li>
		<li>If no bids were made and the time has elapsed, the funds remain in the contract, and a new auction begins.</li>
		<li>The last bidder who placed a bid becomes the winner of the auction.</li>
		<li>The winner receives a reward of 100,000 PLS, which is transferred to their address.</li>
		<li>After the auction ends, the last bidder's address and the bid price are reset.</li>
		<li>The contract owner has the ability to deposit additional funds into the contract.</li>
		<li>Please note that before participating in the auction, you need to connect to the contract using a MetaMask wallet or other Ethereum-compatible software.</li>
	</ul>
	
	<!-- Polish Translation -->
	<h2>Zasady udziału:</h2>
	<ul>
		<li>Aukcja rozpoczyna się po wdrożeniu umowy i trwa przez określony czas, domyślnie 3600 sekund (1 godzina).</li>
		<li>Aby dołączyć do aukcji, uczestnicy muszą wysłać transakcję z depozytem o wartości równiej lub większej niż <b>1000 PLS</b>.</li>
		<li>Dołączając do aukcji, jeśli pozostały czas jest mniejszy niż 5 minut, do czasu zakończenia aukcji dodawana jest 1 minuta.</li>
		<li>Jeśli czas zakończenia aukcji minął, aukcja jest zakończona.</li>
		<li>Jeśli nie złożono żadnych ofert i czas minął, środki pozostają w umowie, a rozpoczyna się nowa aukcja.</li>
		<li>Ostatni oferent, który złożył ofertę, zostaje zwycięzcą aukcji.</li>
		<li>Zwycięzca otrzymuje nagrodę w wysokości 100 000 PLS, która zostaje przesłana na jego adres.</li>
		<li>Po zakończeniu aukcji adres ostatniego oferenta i cena oferty są resetowane.</li>
		<li>Właściciel umowy ma możliwość wpłacania dodatkowych środków na umowę.</li>
		<li>Przed udziałem w aukcji należy połączyć się z umową za pomocą portfela MetaMask lub innego oprogramowania zgodnego z Ethereum.</li>
	</ul>
</body>
</html>
